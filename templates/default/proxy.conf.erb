# THIS FILE HAS BEEN GENERATED BY CHEF
# ANY MANUAL MODIFICATIONS WILL BE OVERWRITTEN

<% @app.upstreams.each do |upstream| -%>
upstream <%= upstream.fetch(:name) { @app.name } %> {
  <% upstream.fetch(:servers).each do |upstream_server| -%>
  server <%= upstream_server %>;
  <% end -%>
  keepalive <%= upstream.fetch(:keepalive) { @app.upstream_keepalive } %>;
}

<% end -%>
<% unless @app.name.include?("upstream") -%>
server {
  <% @app.listen.each do |listen| -%>
  listen <%= listen %>;
  <% end %>
  server_name <%= @app.server_name %>;
  <% if @app.public_path -%>
  root <%= @app.public_path %>;
  <% end %>

  client_max_body_size <%= @app.client_max_body_size %>;
  keepalive_timeout <%= @app.keepalive_timeout %>;
  <%= @app.custom_directives.join("\n\s\s") -%>

  <% if @app.try_files.any? -%>
  try_files <%= @app.try_files.join(" ") %>;
  <% end %>

  <% @app.locations.each do |location| -%>
  location <%= location.fetch(:path) %> {
    <%= location.fetch(:directives).join("\n\s\s\s\s") %>
  }

  <% end %>

  <% if @app.access_log.empty? -%>
  access_log <%= node[:nginx][:log_dir] %>/<%= @app.name %>.access.log <%= @app.access_log_format %>;
  <% else %>
  access_log <%= @app.access_log %>;
  <% end %>

  <% if @app.error_log.empty? -%>
  error_log <%= node[:nginx][:log_dir] %>/<%= @app.name %>.error.log;
  <% else %>
  error_log <%= @app.error_log %>;
  <% end %>

  include <%= node[:nginx][:sites_common_dir] %>/*conf;
}
<% end -%>