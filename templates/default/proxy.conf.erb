# THIS FILE HAS BEEN GENERATED BY CHEF
# ANY MANUAL MODIFICATIONS WILL BE OVERWRITTEN

<% @app.upstreams.each do |upstream| -%>
upstream <%= upstream.fetch(:name) { @app.name } %> {
  <% upstream.fetch(:servers).each do |upstream_server| -%>
  server <%= upstream_server %>;
  <% end -%>
  keepalive <%= upstream.fetch(:keepalive) { @app.upstream_keepalive } %>;
}

<% end -%>
<% unless @app.name.include?("upstream") -%>
server {
  <% @app.listen.each do |listen| -%>
  listen <%= listen %>;
  <% end %>
  <% if @app.server_name -%>
  server_name <%= @app.server_name %>;
  <% end %>
  <% if @app.public_path -%>
  root <%= @app.public_path %>;
  <% end %>

  client_max_body_size <%= @app.client_max_body_size %>;
  keepalive_timeout <%= @app.keepalive_timeout %>;
  <%= @app.custom_directives.join("\n\s\s") -%>

  <% if @app.try_files.any? -%>
  try_files <%= @app.try_files.join(" ") %>;
  <% end %>

  <% @app.locations.each do |location| -%>
  location <%= location.fetch(:path) %> {
    <%= location.fetch(:directives).join("\n\s\s\s\s") %>
  }

  <% end %>

  access_log <%= @app.access_log_path %> <%= @app.access_log_format unless @app.access_log_path == "off" %>;
  error_log <%= @app.error_log_path %> <%= @app.error_log_format unless @app.error_log_path == "off" %>;

  include <%= node[:nginx][:sites_common_dir] %>/*conf;
}
<% end -%>
